___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Snowplow",
  "categories": [
    "ANALYTICS",
    "DATA_WAREHOUSING",
    "TAG_MANAGEMENT"
  ],
  "brand": {
    "id": "github.com_snowplow",
    "displayName": "snowplow",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Official template for Snowplow. Forward events to a Snowplow collector, from the Snowplow client or other clients which populate the common event model.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "collectorUrl",
    "displayName": "Collector URL",
    "simpleValueType": true,
    "help": "The URL of your Snowplow collector. Defaults to https, specify http protocol if you don\u0027t want https. e.g. collector.mywebsite.com or http://collector.mywebsite.com",
    "alwaysInSummary": true,
    "notSetText": "(Required) Collector URL has not been set",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "cookieSettings",
    "displayName": "Cookie Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "userIdCookie",
        "displayName": "Name",
        "simpleValueType": true,
        "help": "The name of the cookie returned by your Snowplow collector",
        "defaultValue": "sp",
        "canBeEmptyString": true,
        "alwaysInSummary": true
      },
      {
        "type": "CHECKBOX",
        "name": "cookieOverrideEnabled",
        "checkboxText": "Override Cookie properties",
        "simpleValueType": true,
        "help": "Enable this to override the collector cookie with your own settings",
        "defaultValue": false
      },
      {
        "type": "TEXT",
        "name": "cookieDomain",
        "displayName": "Domain Override",
        "simpleValueType": true,
        "help": "The host to which the cookie will be sent. If set to the special value \"auto\", then the host will be automatically computed as the eTLD+1 of the first header found in the following priority order: 1. \"Forwarded\", 2. \"X-Forwarded-Host\", 3. \"Host\".",
        "defaultValue": "auto",
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "cookiePath",
        "displayName": "Path Override",
        "simpleValueType": true,
        "defaultValue": "/",
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "cookieSameSite",
        "displayName": "SameSite Override",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "Strict",
            "displayValue": "Strict"
          },
          {
            "value": "Lax",
            "displayValue": "Lax"
          },
          {
            "value": "None",
            "displayValue": "None"
          },
          {
            "value": "unset",
            "displayValue": "Value not set"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "None",
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "cookieExpiration",
        "displayName": "Expiration Override in Seconds",
        "simpleValueType": true,
        "help": "The cookie expiration, in seconds. If set to 0, the cookie will be set as a session cookie and expire when the user\u0027s current browser session ends.",
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "defaultValue": 63072000
      },
      {
        "type": "CHECKBOX",
        "name": "cookieHttpOnly",
        "checkboxText": "HttpOnly",
        "simpleValueType": true,
        "defaultValue": true,
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "cookieSecure",
        "checkboxText": "Secure",
        "simpleValueType": true,
        "defaultValue": true,
        "enablingConditions": [
          {
            "paramName": "cookieOverrideEnabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "cookieHeadersGroup",
        "displayName": "Cookie Headers",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "forwardCookieHeaders",
            "checkboxText": "Forward Cookies in the request headers",
            "simpleValueType": true,
            "help": "Enable this to allow forwarding selected cookies in the request headers.",
            "defaultValue": false,
            "alwaysInSummary": true
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "cookiesToForward",
            "displayName": "Cookies to forward",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Cookie Name",
                "name": "cookieName",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "isUnique": true
              },
              {
                "defaultValue": "no",
                "displayName": "Decode",
                "name": "decode",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "no",
                    "displayValue": "No"
                  },
                  {
                    "value": "yes",
                    "displayValue": "Yes"
                  }
                ]
              }
            ],
            "help": "Specify the cookie names to forward and whether you want to decode the cookie value(s) before forwarding.",
            "enablingConditions": [
              {
                "paramName": "forwardCookieHeaders",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customEvents",
    "displayName": "Advanced Event Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "GROUP",
        "name": "structuredGroup",
        "displayName": "Structured events",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "defineAsStructured",
            "checkboxText": "Send selected events as Snowplow Structured Events",
            "simpleValueType": true,
            "subParams": [
              {
                "type": "TEXT",
                "name": "customStructuredDefs",
                "displayName": "Event name(s) selected",
                "simpleValueType": true,
                "enablingConditions": [
                  {
                    "paramName": "defineAsStructured",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "textAsList": true,
                "lineCount": 2,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "Add the event names (in separate lines) to be tracked as custom structured Snowplow events."
              }
            ],
            "help": "Enable this to allow setting custom structured events."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "selfDescGroup",
        "displayName": "Self-describing events",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "defineAsSelfDescribing",
            "checkboxText": "Define events to be sent as Snowplow Self-Describing Events",
            "simpleValueType": true,
            "subParams": [
              {
                "type": "PARAM_TABLE",
                "name": "customEventSchemas",
                "displayName": "Event Name to Schema",
                "paramTableColumns": [
                  {
                    "param": {
                      "type": "TEXT",
                      "name": "eventName",
                      "displayName": "Event Name",
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": true
                  },
                  {
                    "param": {
                      "type": "TEXT",
                      "name": "eventSchema",
                      "displayName": "Event Schema",
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": true
                  }
                ],
                "enablingConditions": [
                  {
                    "paramName": "defineAsSelfDescribing",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "A table of the events (event names and corresponding schemas) to be tracked as custom self-describing Snowplow events."
              },
              {
                "type": "PARAM_TABLE",
                "name": "customEventData",
                "displayName": "Event Definitions",
                "paramTableColumns": [
                  {
                    "param": {
                      "type": "TEXT",
                      "name": "eventName",
                      "displayName": "Event Name",
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": false
                  },
                  {
                    "param": {
                      "type": "TEXT",
                      "name": "snowplowPropName",
                      "displayName": "Snowplow property name",
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": false
                  },
                  {
                    "param": {
                      "type": "SELECT",
                      "name": "type",
                      "displayName": "Type",
                      "macrosInSelect": false,
                      "selectItems": [
                        {
                          "value": "default",
                          "displayValue": "Default"
                        },
                        {
                          "value": "string",
                          "displayValue": "String"
                        },
                        {
                          "value": "boolean",
                          "displayValue": "Boolean"
                        },
                        {
                          "value": "number",
                          "displayValue": "Number"
                        }
                      ],
                      "simpleValueType": true
                    },
                    "isUnique": false
                  },
                  {
                    "param": {
                      "type": "SELECT",
                      "name": "ref",
                      "displayName": "Reference",
                      "macrosInSelect": false,
                      "selectItems": [
                        {
                          "value": "eventProperty",
                          "displayValue": "Client Event Property"
                        },
                        {
                          "value": "userSet",
                          "displayValue": "Constant or Variable"
                        }
                      ],
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": false
                  },
                  {
                    "param": {
                      "type": "TEXT",
                      "name": "value",
                      "displayName": "Value",
                      "simpleValueType": true,
                      "valueValidators": [
                        {
                          "type": "NON_EMPTY"
                        }
                      ]
                    },
                    "isUnique": false
                  }
                ],
                "enablingConditions": [
                  {
                    "paramName": "defineAsSelfDescribing",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "A table of definitions for self-describing data properties. Each row maps a single data property of a custom self-describing Snowplow event to its value."
              }
            ],
            "help": "Enable this to allow custom self-describing event definitions."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "entitiesGroup",
        "displayName": "Context entities",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "applyToSp",
            "checkboxText": "Apply context entities settings also to Snowplow events",
            "simpleValueType": true,
            "help": "Enable this tick box to also apply context entities settings to raw Snowplow events.",
            "defaultValue": false
          },
          {
            "type": "GROUP",
            "name": "entitiesSettingsGroup",
            "displayName": "Context entities settings",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "GROUP",
                "name": "customEntitiesGroup",
                "displayName": "Custom context entities",
                "groupStyle": "ZIPPY_CLOSED",
                "subParams": [
                  {
                    "type": "CHECKBOX",
                    "name": "customUseVariables",
                    "checkboxText": "Use variables to define custom context entities",
                    "simpleValueType": true,
                    "help": "Enabling this setting allows you to set custom context entities using a variable that returns the entities \u003cstrong\u003earray\u003c/strong\u003e to attach to the event."
                  },
                  {
                    "type": "PARAM_TABLE",
                    "name": "customEntities",
                    "displayName": "Define custom context entities",
                    "paramTableColumns": [
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "eventName",
                          "displayName": "Event Name",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "ctxSchema",
                          "displayName": "Entity schema",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "ctxProp",
                          "displayName": "Entity Property Name",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "SELECT",
                          "name": "type",
                          "displayName": "Type",
                          "macrosInSelect": false,
                          "selectItems": [
                            {
                              "value": "default",
                              "displayValue": "Default"
                            },
                            {
                              "value": "string",
                              "displayValue": "String"
                            },
                            {
                              "value": "boolean",
                              "displayValue": "Boolean"
                            },
                            {
                              "value": "number",
                              "displayValue": "Number"
                            }
                          ],
                          "simpleValueType": true,
                          "defaultValue": "default"
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "SELECT",
                          "name": "ref",
                          "displayName": "Reference",
                          "macrosInSelect": false,
                          "selectItems": [
                            {
                              "value": "eventProperty",
                              "displayValue": "Client Event Property"
                            },
                            {
                              "value": "userSet",
                              "displayValue": "Constant or Variable"
                            }
                          ],
                          "simpleValueType": true,
                          "defaultValue": "eventProperty"
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "value",
                          "displayName": "Value",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      }
                    ],
                    "enablingConditions": [
                      {
                        "paramName": "customUseVariables",
                        "paramValue": false,
                        "type": "EQUALS"
                      }
                    ],
                    "help": "Custom Entities are attached where the event_name matches the incoming event."
                  },
                  {
                    "type": "SIMPLE_TABLE",
                    "name": "customEntitiesFromVar",
                    "displayName": "Set custom context entities through variables",
                    "simpleTableColumns": [
                      {
                        "defaultValue": "",
                        "displayName": "Event Name",
                        "name": "eventName",
                        "type": "TEXT",
                        "valueValidators": [
                          {
                            "type": "NON_EMPTY"
                          }
                        ],
                        "isUnique": true
                      },
                      {
                        "defaultValue": "",
                        "displayName": "Custom Entities Array",
                        "name": "customContexts",
                        "type": "TEXT",
                        "valueValidators": [
                          {
                            "type": "NON_EMPTY"
                          }
                        ]
                      }
                    ],
                    "enablingConditions": [
                      {
                        "paramName": "customUseVariables",
                        "paramValue": true,
                        "type": "EQUALS"
                      }
                    ],
                    "help": "Custom Entities are attached where the event_name matches the incoming event."
                  }
                ]
              },
              {
                "type": "GROUP",
                "name": "globalEntitiesGroup",
                "displayName": "Global context entities",
                "groupStyle": "ZIPPY_CLOSED",
                "subParams": [
                  {
                    "type": "CHECKBOX",
                    "name": "globalUseVariable",
                    "checkboxText": "Use a variable to define global context entities",
                    "simpleValueType": true,
                    "defaultValue": false,
                    "help": "Enabling this setting allows you to set global context entities using a variable that returns the entities \u003cstrong\u003earray\u003c/strong\u003e to attach to events."
                  },
                  {
                    "type": "PARAM_TABLE",
                    "name": "globalEntities",
                    "displayName": "Define global context entities",
                    "paramTableColumns": [
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "ctxSchema",
                          "displayName": "Entity schema",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "ctxProp",
                          "displayName": "Entity Property Name",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "SELECT",
                          "name": "type",
                          "displayName": "Type",
                          "macrosInSelect": false,
                          "selectItems": [
                            {
                              "value": "default",
                              "displayValue": "Default"
                            },
                            {
                              "value": "string",
                              "displayValue": "String"
                            },
                            {
                              "value": "boolean",
                              "displayValue": "Boolean"
                            },
                            {
                              "value": "number",
                              "displayValue": "Number"
                            }
                          ],
                          "simpleValueType": true,
                          "defaultValue": "default"
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "SELECT",
                          "name": "ref",
                          "displayName": "Reference",
                          "macrosInSelect": false,
                          "selectItems": [
                            {
                              "value": "eventProperty",
                              "displayValue": "Client Event Property"
                            },
                            {
                              "value": "userSet",
                              "displayValue": "Constant or Variable"
                            }
                          ],
                          "simpleValueType": true,
                          "defaultValue": "eventProperty"
                        },
                        "isUnique": false
                      },
                      {
                        "param": {
                          "type": "TEXT",
                          "name": "value",
                          "displayName": "Value",
                          "simpleValueType": true,
                          "valueValidators": [
                            {
                              "type": "NON_EMPTY"
                            }
                          ]
                        },
                        "isUnique": false
                      }
                    ],
                    "enablingConditions": [
                      {
                        "paramName": "globalUseVariable",
                        "paramValue": false,
                        "type": "EQUALS"
                      }
                    ],
                    "help": "Global Entities are attached to all events."
                  },
                  {
                    "type": "TEXT",
                    "name": "globalEntitiesFromVar",
                    "displayName": "Set global context entities through variable",
                    "simpleValueType": true,
                    "enablingConditions": [
                      {
                        "paramName": "globalUseVariable",
                        "paramValue": true,
                        "type": "EQUALS"
                      }
                    ],
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY"
                      }
                    ],
                    "help": "Global Entities are attached to all events."
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "additionalSettingsGroup",
        "displayName": "Additional event settings",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "encodeBase64",
            "checkboxText": "Base64 encoding",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": true,
            "help": "Whether to encode the custom self-describing event data."
          },
          {
            "type": "SELECT",
            "name": "platform",
            "displayName": "Platform identifier",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "web",
                "displayValue": "Web"
              },
              {
                "value": "mob",
                "displayValue": "Mobile"
              },
              {
                "value": "pc",
                "displayValue": "Desktop/Laptop"
              },
              {
                "value": "srv",
                "displayValue": "Server-side"
              },
              {
                "value": "app",
                "displayValue": "General App"
              },
              {
                "value": "tv",
                "displayValue": "Connected TV"
              },
              {
                "value": "cnsl",
                "displayValue": "Games Console"
              },
              {
                "value": "iot",
                "displayValue": "Internet of things"
              }
            ],
            "simpleValueType": true,
            "help": "The application platform",
            "defaultValue": "srv"
          },
          {
            "type": "TEXT",
            "name": "appId",
            "displayName": "App ID",
            "simpleValueType": true,
            "help": "Use this option to set the app_id for your events. If the value provided is not a string, it will be ignored.",
            "alwaysInSummary": true
          }
        ]
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log",
            "help": "This option completely disables logging."
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview",
            "help": "This option allows logging only in debug and preview containers. Please consider that the logs produced by the Snowplow Tag include event data."
          },
          {
            "value": "always",
            "displayValue": "Always log to console",
            "help": "This option enables logging in any container. Please consider that when enabled, the logs produced by the Snowplow Tag include event data."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Server-side tagging API imports
const createRegex = require('createRegex');
const decodeUriComponent = require('decodeUriComponent');
const getAllEventData = require('getAllEventData');
const getCookieValues = require('getCookieValues');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const log = require('logToConsole');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const Math = require('Math');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');
const toBase64 = require('toBase64');
const getRequestHeader = require('getRequestHeader');
const getContainerVersion = require('getContainerVersion');

// Constants
const spPayloadDataSchema =
  'iglu:com.snowplowanalytics.snowplow/payload_data/jsonschema/1-0-4';
const spSelfDescribingSchema =
  'iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0';
const spContextsSchema =
  'iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0';
const spPostPath = '/com.snowplowanalytics.snowplow/tp2';
const spVersion = 'gtmss-0.6.0';
const tagName = 'Snowplow';

// event data mappings for self-describing Snowplow events
const videoDataMappings = [
  {
    spPropName: 'video_current_time',
    type: 'number',
    ref: 'eventProperty',
    value: 'video_current_time',
  },
  {
    spPropName: 'video_duration',
    type: 'number',
    ref: 'eventProperty',
    value: 'video_duration',
  },
  {
    spPropName: 'video_percent',
    type: 'number',
    ref: 'eventProperty',
    value: 'video_percent',
  },
  {
    spPropName: 'video_provider',
    type: 'string',
    ref: 'eventProperty',
    value: 'video_provider',
  },
  {
    spPropName: 'video_title',
    type: 'string',
    ref: 'eventProperty',
    value: 'video_title',
  },
  {
    spPropName: 'video_url',
    type: 'string',
    ref: 'eventProperty',
    value: 'video_url',
  },
  {
    spPropName: 'visible',
    type: 'boolean',
    ref: 'eventProperty',
    value: 'visible',
  },
];

const spDefaultCustomDefs = {
  page_view: {
    eventType: 'pv',
  },
  // server side
  add_payment_info: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/add_payment_info/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value', 'coupon', 'payment_type', 'items'],
  },
  add_to_cart: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/add_to_cart/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value', 'items'],
  },
  add_to_wishlist: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/add_to_wishlist/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value', 'items'],
  },
  begin_checkout: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/begin_checkout/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value', 'coupon', 'items'],
  },
  exception: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/exception/jsonschema/1-0-0',
    eventDataMappings: [
      {
        spPropName: 'description',
        type: 'string',
        ref: 'eventProperty',
        value: 'description',
      },
      {
        spPropName: 'fatal',
        type: 'boolean',
        ref: 'eventProperty',
        value: 'fatal',
      },
    ],
  },
  generate_lead: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/generate_lead/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value'],
  },
  join_group: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/join_group/jsonschema/1-0-0',
    eventDataMappings: ['group_id'],
  },
  login: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/login/jsonschema/1-0-0',
    eventDataMappings: ['method'],
  },
  purchase: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/purchase/jsonschema/1-0-0',
    eventDataMappings: [
      'currency',
      'transaction_id',
      'value',
      'affiliation',
      'coupon',
      'shipping',
      'tax',
      'items',
    ],
  },
  refund: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/refund/jsonschema/1-0-0',
    eventDataMappings: [
      'currency',
      'transaction_id',
      'value',
      'affiliation',
      'coupon',
      'shipping',
      'tax',
      'items',
    ],
  },
  search: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/search/jsonschema/1-0-0',
    eventDataMappings: ['search_term'],
  },
  select_content: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/select_content/jsonschema/1-0-0',
    eventDataMappings: ['content_type', 'item_id'],
  },
  share: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/share/jsonschema/1-0-0',
    eventDataMappings: ['method', 'content_type', 'item_id'],
  },
  sign_up: {
    eventType: 'ue',
    eventSchema: 'com.google.tag-manager.server-side/sign_up/jsonschema/1-0-0',
    eventDataMappings: ['method'],
  },
  view_item: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/view_item/jsonschema/1-0-0',
    eventDataMappings: ['currency', 'value', 'items'],
  },
  view_item_list: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/view_item_list/jsonschema/1-0-0',
    eventDataMappings: ['item_list_id', 'item_list_name', 'items'],
  },
  view_search_results: {
    eventType: 'ue',
    eventSchema:
      'com.google.tag-manager.server-side/view_search_results/jsonschema/1-0-0',
    eventDataMappings: ['search_term', 'items'],
  },
  // enhanced measurement
  click: {
    eventType: 'ue',
    eventSchema: 'com.google.ga4.enhanced-measurement/click/jsonschema/1-0-0',
    eventDataMappings: [
      {
        spPropName: 'link_classes',
        type: 'string',
        ref: 'eventProperty',
        value: 'link_classes',
      },
      {
        spPropName: 'link_domain',
        type: 'string',
        ref: 'eventProperty',
        value: 'link_domain',
      },
      {
        spPropName: 'link_id',
        type: 'string',
        ref: 'eventProperty',
        value: 'link_id',
      },
      {
        spPropName: 'link_url',
        type: 'string',
        ref: 'eventProperty',
        value: 'link_url',
      },
      {
        spPropName: 'outbound',
        type: 'boolean',
        ref: 'eventProperty',
        value: 'outbound',
      },
    ],
  },
  file_download: {
    eventType: 'ue',
    eventSchema:
      'com.google.ga4.enhanced-measurement/file_download/jsonschema/1-0-0',
    eventDataMappings: [
      'file_extention',
      'file_name',
      'link_classes',
      'link_domain',
      'link_id',
      'link_text',
      'link_url',
    ],
  },
  scroll: {
    eventType: 'ue',
    eventSchema: 'com.google.ga4.enhanced-measurement/scroll/jsonschema/1-0-0',
    eventDataMappings: [],
  },
  video_complete: {
    eventType: 'ue',
    eventSchema:
      'com.google.ga4.enhanced-measurement/video_complete/jsonschema/1-0-0',
    eventDataMappings: videoDataMappings,
  },
  video_progress: {
    eventType: 'ue',
    eventSchema:
      'com.google.ga4.enhanced-measurement/video_progress/jsonschema/1-0-0',
    eventDataMappings: videoDataMappings,
  },
  video_start: {
    eventType: 'ue',
    eventSchema:
      'com.google.ga4.enhanced-measurement/video_start/jsonschema/1-0-0',
    eventDataMappings: videoDataMappings,
  },
  // ga4 automatically collected
  first_visit: {
    eventType: 'ue',
    eventSchema: 'com.google.ga4/first_visit/jsonschema/1-0-0',
    eventDataMappings: [],
  },
  session_start: {
    eventType: 'ue',
    eventSchema: 'com.google.ga4/session_start/jsonschema/1-0-0',
    eventDataMappings: [],
  },
  user_engagement: {
    eventType: 'ue',
    eventSchema: 'com.google.ga4/user_engagement/jsonschema/1-0-0',
    eventDataMappings: ['engagement_time_msec'],
  },
};

// Helpers

/**
 * Assumes logType argument is string.
 * Determines if logging is enabled.
 *
 * @param {string} logType - The logType set ('no', 'debug', 'always')
 * @returns {boolean} Whether logging is enabled
 */
const determineIsLoggingEnabled = (logType) => {
  const containerVersion = getContainerVersion();
  const isDebugMode = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!logType) {
    return isDebugMode;
  }
  if (data.logType === 'no') {
    return false;
  }
  if (data.logType === 'debug') {
    return isDebugMode;
  }

  return data.logType === 'always';
};

/**
 * Creates the log message and logs it to console.
 *
 * @param {string} typeName - The type of log ('Message', 'Request', 'Response')
 * @param {Object} stdInfo - The standard info for all logs (Name, Type, TraceId, EventName)
 * @param {Object} logInfo - An object including information for the specific log type
 */
const doLogging = (typeName, stdInfo, logInfo) => {
  const logMessage = {
    Name: stdInfo.tagName,
    Type: typeName,
    TraceId: stdInfo.traceId,
    EventName: stdInfo.eventName,
  };

  switch (typeName) {
    case 'Message':
      logMessage.Message = logInfo.msg;
      break;
    case 'Request':
      logMessage.RequestMethod = logInfo.requestMethod;
      logMessage.RequestUrl = logInfo.requestUrl;
      logMessage.RequestHeaders = logInfo.requestHeaders;
      logMessage.RequestBody = logInfo.requestBody;
      break;
    case 'Response':
      logMessage.ResponseStatusCode = logInfo.responseStatusCode;
      logMessage.ResponseHeaders = logInfo.responseHeaders;
      logMessage.ResponseBody = logInfo.responseBody;
      break;
    default:
      // do nothing
      return;
  }

  log(JSON.stringify(logMessage));
};

/**
 * Fails the tag.
 * If logs are enabled, also logs a message before failing.
 *
 * @param {boolean} logsEnabled - Whether logs are enabled
 * @param {Object} stdInfo - The standard info for all logs (Name, Type, TraceId, EventName)
 * @param {Object} logInfo - An object including information for the Message
 */
const fail = (logsEnabled, stdInfo, logInfo) => {
  if (logsEnabled) {
    doLogging('Message', stdInfo, logInfo);
  }
  return data.gtmOnFailure();
};

/**
 * Merges objects.
 *
 * @param {Object[]} args - The array of objects to merge
 * @returns {Object} The resulting object
 */
const merge = (args) => {
  let target = {};

  const addToTarget = (obj) => {
    for (let prop in obj) {
      if (obj.hasOwnProperty(prop)) {
        target[prop] = obj[prop];
      }
    }
  };

  for (let i = 0; i < args.length; i++) {
    addToTarget(args[i]);
  }

  return target;
};

/**
 * Encodes a string in base64url.
 *
 * @param {string} str - The string to encode
 * @returns {string} The encoded string
 */
const base64urlencode = (str) => {
  if (!str) {
    return str;
  }

  const rexp = createRegex('[=+/]', 'g');
  return toBase64(str).replace(rexp, (match) => {
    switch (match) {
      case '=':
        return '';
      case '+':
        return '-';
      case '/':
        return '_';
      default:
        return match;
    }
  });
};

/**
 * Parses the cookie attributes of set-cookie header and returns the corresponding object.
 * @example
 * // returns { name:value, Secure:true, HttpOnly:true }
 * parseCookie('name=value; Secure; HttpOnly')
 *
 * @param {string} str - The set-cookie header value
 * @returns {Object}
 */
const parseCookie = (str) =>
  makeString(str)
    .split(';')
    .map((value) => value.split('='))
    .reduce((acc, value) => {
      if (value.length > 1) {
        acc[decodeUriComponent(value[0].trim())] = decodeUriComponent(
          value[1].trim()
        );
      } else {
        acc[decodeUriComponent(value[0].trim())] = true;
      }
      return acc;
    }, {});

/**
 * Sets the cookie
 * (assumes: if headers['set-cookie'])
 *
 * @param {Object} headers - The headers
 * @param {Object} data - The tag configuration
 */
const setCookieFrom = (headers, data) => {
  const cookieValues = parseCookie(headers['set-cookie']);
  let cookieProperties = {
    domain: cookieValues.Domain || 'auto',
    path: cookieValues.Path || '/',
    httpOnly: cookieValues.HttpOnly || true,
    secure: cookieValues.Secure || true,
    sameSite: cookieValues.SameSite || 'Lax',
  };

  if (cookieValues.Expires) {
    cookieProperties.expires = cookieValues.Expires;
  } else {
    cookieProperties['max-age'] = 63072000;
  }

  if (data.cookieOverrideEnabled) {
    cookieProperties = {
      'max-age': data.cookieExpiration,
      domain: data.cookieDomain,
      path: data.cookiePath,
      httpOnly: data.cookieHttpOnly,
      secure: data.cookieSecure,
      sameSite: data.cookieSameSite,
    };
  }

  setCookie(
    data.userIdCookie,
    cookieValues[data.userIdCookie],
    cookieProperties
  );
};

/**
 * Given name and value strings returns 'name=value'.
 *
 * @param {string} name - The cookie name
 * @param {string} value - The cookie value
 * @returns {string}
 */
const mkCookie = (name, value) => {
  return makeString(name) + '=' + makeString(value);
};

/**
 * Joins an array of cookie-pairs ('name=value' strings).
 *
 * @param {string[]} args - The array of cookie pairs
 * @returns {string}
 */
const joinCookies = (args) => {
  const separator = '; ';
  return args.filter((c) => !!c).join(separator);
};

/**
 * Creates a Cookie header value based on the cookiesToForward field
 * of the tag configuration.
 *
 * @param {Object} tagConfig - The tag configuration
 * @returns {string}
 */
const mkCookies = (tagConfig) => {
  if (!tagConfig.forwardCookieHeaders) {
    return '';
  }

  const cookiesToForward = tagConfig.cookiesToForward;
  if (cookiesToForward && cookiesToForward.length > 0) {
    const cookies = cookiesToForward
      .map((row) => {
        // cookieName cannot be empty (see validation rules)
        const cookieName = row.cookieName;
        const decode = row.decode === 'yes' ? true : false;

        // getCookieValues returns empty array if no such cookie
        const cookieValues = getCookieValues(cookieName, !decode);
        return cookieValues.map((v) => (v ? mkCookie(cookieName, v) : ''));
      })
      .reduce((acc, curr) => {
        return acc.concat(curr);
      }, []);
    const cookieHeader = joinCookies(cookies);
    return cookieHeader;
  }
  return '';
};

/**
 * Creates the headers for the request. Namely:
 *   - Content-Type
 *   - User-Agent (if exists in event)
 *   - Cookie:
 *     - user id (based on userIdCookie field)
 *     - selected cookies (from cookiesToForward field)
 *   - SP-Anonymous
 *
 * @param {Object} event - The event object
 * @returns {Object} The headers for the request
 */
const getHeaders = (event) => {
  const headers = {
    'Content-Type': 'application/json',
  };
  const userAgent = event.user_agent;
  if (userAgent) {
    headers['User-Agent'] = userAgent;
  }
  const userIdCookie = getCookieValues(data.userIdCookie)[0];
  if (userIdCookie) {
    headers.Cookie = mkCookie(data.userIdCookie, userIdCookie);
  }
  if (event['x-sp-anonymous']) {
    headers['SP-Anonymous'] = '*';
  }

  const cookiesForwarded = mkCookies(data);
  const cookieHeader = joinCookies([headers.Cookie, cookiesForwarded]);
  if (cookieHeader) {
    headers.Cookie = cookieHeader;
  }

  return headers;
};

/**
 * Adds https as the default protocol if not provided in collector url.
 *
 * @param {string} collectorUrl - The collector URL
 * @returns {string}
 */
const asCollectorUrl = (collectorUrl) => {
  if (collectorUrl.indexOf('http') === 0) {
    return collectorUrl;
  }
  return 'https://' + collectorUrl;
};

/**
 * Adds iglu if not provided in the schema.
 *
 * @param {string} schema - The provided schema
 * @returns {string}
 */
const asIgluSchema = (schema) => {
  if (schema.indexOf('iglu:') === 0) {
    return schema;
  }
  return 'iglu:' + schema;
};

/**
 * Returns a boolean from a value, maps the string 'false' to boolean false.
 *  e.g. asBoolean('false') => false
 *
 * @param {*} val - The provided value
 * @returns {boolean}
 */
const asBoolean = (val) => {
  if (val === 'false') {
    return false;
  }
  return !!val;
};

/**
 * Ovewrites the default custom event definitions with the user provided ones if any.
 * Does not validate data - assumes the non-empty validation rule.
 *
 * @param {Object} tagConfig - The tag configuration
 * @param {Object} defaultDefinitions - The default event definitions
 * @returns {Object} The final event definitions
 */
const mkCustomDefs = (tagConfig, defaultDefinitions) => {
  const newDefinitions = {};
  if (tagConfig.defineAsStructured) {
    tagConfig.customStructuredDefs.forEach((evName) => {
      if (evName) {
        newDefinitions[evName] = {
          eventType: 'se',
        };
      }
    });
  }

  if (tagConfig.defineAsSelfDescribing) {
    tagConfig.customEventSchemas.forEach((row) => {
      const evName = row.eventName;
      const mappings = tagConfig.customEventData
        .filter((r) => r.eventName === evName)
        .map((m) => {
          return {
            spPropName: m.snowplowPropName,
            type: m.type,
            ref: m.ref,
            value: m.value,
          };
        });
      newDefinitions[evName] = {
        eventType: 'ue',
        eventSchema: row.eventSchema,
        eventDataMappings: mappings,
      };
    });
  }

  return merge([defaultDefinitions, newDefinitions]);
};

/**
 * Helper that wraps mkCustomDefs and returns a function that closes over the
 * provided event definitions.
 *
 * @param {Object} definitions - The event definitions to use
 * @returns {function} A function that given the tag configuration returns the final event definitions
 */
const withDefinitions = (definitions) => {
  return function (tagConfig) {
    return mkCustomDefs(tagConfig, definitions);
  };
};

/**
 * Returns whether a string can be parsed as an integer.
 *
 * @param {string} x - The string to check
 * @returns {boolean}
 */
const isInt = (x) => {
  const y = Math.floor(x);
  if (y === 0) {
    return true;
  }
  return !!y;
};

/**
 * Splits a string as a path where path components are separated by dots.
 * (used by both getFromPath and setFromPath)
 *
 * @param {string} stringPath - The string to split
 * @returns {string[]} The array of path components
 */
const splitStringPath = (stringPath) => {
  return stringPath.split('.').filter((p) => !!p);
};

/**
 * Gets the value in obj from path.
 * Path must be a string denoting a (nested) property path separated by '.'
 *  e.g. getFromPath('a.b', {a: {b: 2}}) => 2
 *
 * @param {string} path - The path to get the value of
 * @param {Object} obj - The object to look into
 * @returns {*} The corresponding value or undefined
 */
const getFromPath = (path, obj) => {
  if (getType(path) === 'string') {
    const splitPath = splitStringPath(path);
    return splitPath.reduce((acc, curr) => {
      return acc && acc[curr];
    }, obj);
  }
  return undefined;
};

/**
 * Sets the value in obj from path (side-effects).
 * Overwrites if encounters existing properties, and creates nesting if needed.
 * @example
 * // returns {a: {b: {c: 3}}}
 * setFromPath('a.b.c', 3, {a: {b: 0}})
 * @example
 * // returns {a: [{x: 4}]}
 * setFromPath('a.0.x', 4, {a: {b: 0}})
 * @example
 * // returns {a: [4]}
 * setFromPath('a.0', 4, {a: {b: 0}})
 * @example
 * // returns {a: [1,1,5]}
 * setFromPath('a.2', 5, {a: [1,1,1]})
 *
 * @param {(string|string[])} path - The path where to set the value
 * @param {*} val - The value to be set
 * @param {Object} obj - The object to mutate
 * @param {Object} [target] - The object that the path refers to
 * @returns {Object} The object mutated with the value set
 */
const setFromPath = (path, val, obj, target) => {
  const numAsIdx = true;
  if (!target) {
    target = obj;
  }
  if (getType(path) === 'string') {
    path = splitStringPath(path);
  }
  if (path.length === 1) {
    target[path[0]] = val;
    return obj;
  } else if (path.length > 1) {
    const currKey = path[0];
    const currType = getType(target[currKey]);
    const nextKey = path[1];
    const isNextNum = isInt(nextKey);
    if (
      (!isNextNum && currType !== 'object') ||
      (isNextNum && !numAsIdx && currType !== 'object')
    ) {
      target[currKey] = {};
    } else if (isNextNum && numAsIdx && currType !== 'array') {
      target[currKey] = [];
    }
    return setFromPath(path.slice(1), val, obj, target[currKey]);
  }
  return obj;
};

/**
 * Interprets val according to a type typ.
 * If val is a name (referred to by ref as 'eventProperty'),
 *   interprets its value in (event)object instead.
 *
 * @param {*} val - The value to interpret
 * @param {string} typ - The type (one of number, boolean, string, default)
 * @param {string} ref - Singifies whether val refers to a name in evObj
 * @param {Object} evObj - The object ref may refer to.
 * @returns {*} The interpreted value
 */
function interpret(val, typ, ref, evObj) {
  const deducedVal = ref === 'eventProperty' ? getFromPath(val, evObj) : val;
  switch (typ) {
    case 'number':
      return makeNumber(deducedVal);
    case 'boolean':
      return asBoolean(deducedVal);
    case 'string':
      return makeString(deducedVal);
    default:
      return deducedVal;
  }
}

/**
 * Makes the standard name-value pairs of Snowplow event.
 *
 * @param {Object} evObj - The client event object
 * @param {string} evType - The Snowplow event type ('se' or 'ue')
 * @param {Object} tagConfig - The tag configuration data
 * @returns {Object} The initial Snowplow event object
 */
const mkStandardPairs = (evObj, evType, tagConfig) => {
  const appId = getType(tagConfig.appId) === 'string' ? tagConfig.appId : undefined;
  return {
    e: evType,
    p: tagConfig.platform,
    aid: appId,
    tv: spVersion,
    dtm: makeString(getTimestampMillis()),
    url: evObj.page_location,
    duid: evObj.client_id,
    lang: evObj.language,
    cs: evObj.page_encoding,
    refr: evObj.page_referrer,
    page: evObj.page_title,
    res: evObj.screen_resolution,
    uid: evObj.user_id,
    vp: evObj.viewport_size,
    ip: evObj.ip_override,
  };
};

/**
 * Given a client event, makes a self-describing Snowplow event
 *
 * @param {Object} evObj - The client event object
 * @param {string} evSchema - The schema for the event
 * @param {(string[]|Object[])} mappings - The event data mappings
 * @param {Object} tagConfig - The tag configuration data
 * @returns {Object} The self-describing Snowplow event object
 */
const mkSelfDescribingEvent = (evObj, evSchema, mappings, tagConfig) => {
  const event = mkStandardPairs(evObj, 'ue', tagConfig);
  const selfDescData = mappings.reduce((acc, curr) => {
    if (getType(curr) === 'string') {
      return setFromPath(
        curr,
        interpret(curr, 'default', 'eventProperty', evObj),
        acc
      );
    }
    return setFromPath(
      curr.spPropName,
      interpret(curr.value, curr.type, curr.ref, evObj),
      acc
    );
  }, {});

  const uePr = JSON.stringify({
    schema: spSelfDescribingSchema,
    data: {
      schema: evSchema,
      data: selfDescData,
    },
  });

  const encodeBase64 = tagConfig.encodeBase64;
  if (encodeBase64) {
    event.ue_px = base64urlencode(uePr);
  } else {
    event.ue_pr = uePr;
  }

  return event;
};

/**
 * Given a client event, makes a structured Snowplow event
 *
 * @param {Object} evObj - The client event object
 * @param {Object} tagConfig - The tag configuration data
 * @returns {Object} The structured Snowplow event object
 */
const mkStructuredEvent = (evObj, tagConfig) => {
  const action = evObj.event_action ? evObj.event_action : evObj.event_name;
  const category = evObj.event_category;

  if (action && category) {
    const event = mkStandardPairs(evObj, 'se', tagConfig);
    event.se_ac = action;
    event.se_ca = category;
    event.se_la = evObj.event_label;
    event.se_va = evObj.event_value;

    return event;
  }
  return undefined;
};

/**
 * Makes a Snowplow event from a non-Snowplow client event.
 *
 * @param {Object} evObj - The client event object
 * @param {Object} customDefs - The custom event data definitions
 * @param {Object} tagConfig - The tag configuration data
 * @returns {(Object|undefined)} The Snowplow event or undefined, if event could not be constructed
 */
const mkSnowplowEvent = (evObj, customDefs, tagConfig) => {
  const eventName = evObj.event_name;

  if (!customDefs.hasOwnProperty(eventName)) {
    return undefined;
  }

  if (customDefs[eventName].eventType === 'pv') {
    return mkStandardPairs(evObj, 'pv', tagConfig);
  }

  if (customDefs[eventName].eventType === 'ue') {
    const eventSchema = asIgluSchema(customDefs[eventName].eventSchema);
    const eventMappings = customDefs[eventName].eventDataMappings;

    return mkSelfDescribingEvent(evObj, eventSchema, eventMappings, tagConfig);
  }

  if (customDefs[eventName].eventType === 'se') {
    return mkStructuredEvent(evObj, tagConfig);
  }

  return undefined;
};

/**
 * Helper to ensure an array is returned.
 *
 * @param {*} x
 * @returns {Array}
 */
const asArray = (x) => {
  if (getType(x) !== 'array') {
    return [];
  }
  return x;
};

/**
 * Gets context entities from the configuration option that allows
 * settings custom and/or global contexts using variables.
 *
 * @param {Object} evObj - The event
 * @param {Object} tagConfig - The tag configuration
 * @returns {Object[]} Array of context entities
 */
const getEntitiesFromVariables = (evObj, tagConfig) => {
  const globalCtxFromVar = asArray(tagConfig.globalEntitiesFromVar);
  const customWithVars = asArray(tagConfig.customEntitiesFromVar).filter(
    (row) => row.eventName === evObj.event_name
  );

  // this specific table requires column values to be unique,
  // so there can be at most one relevant row
  if (customWithVars.length === 1) {
    const customCtxFromVar = asArray(customWithVars[0].customContexts);
    return customCtxFromVar.concat(globalCtxFromVar);
  }
  return globalCtxFromVar;
};

/**
 * Makes the context entities to attach to the event.
 *
 * @param {Object} evObj - The event
 * @param {Object} tagConfig - The tag configuration
 * @returns {(Object[]|undefined)} The context entities to attach to Snowplow event
 */
const mkEntities = (evObj, tagConfig) => {
  const eventName = evObj.event_name;
  const customEntities = asArray(tagConfig.customEntities);
  const globalEntities = asArray(tagConfig.globalEntities);

  const initMap = {};
  const initEntities = customEntities
    .filter((r) => r.eventName === eventName)
    .concat(globalEntities)
    .reduce((acc, curr) => {
      const setPath = [asIgluSchema(curr.ctxSchema)].concat(
        splitStringPath(curr.ctxProp)
      );
      const setVal = interpret(curr.value, curr.type, curr.ref, evObj);
      return setFromPath(setPath, setVal, acc);
    }, initMap);

  const constructedEntities = [];
  for (let prop in initEntities) {
    if (initEntities.hasOwnProperty(prop)) {
      constructedEntities.push({
        schema: prop,
        data: initEntities[prop],
      });
    }
  }

  const entitiesFromVar = getEntitiesFromVariables(evObj, tagConfig);
  const finalEntities = constructedEntities.concat(entitiesFromVar);

  return finalEntities.length > 0 ? finalEntities : undefined;
};

/**
 * Determines whether to apply base64 url encoding. It is being used
 * when contexts are added to a Snowplow event.
 * If encoding of the original Snowplow event can be determined, is matched.
 * Else the configuration option applies.
 *
 * @param {Object} spEvent - The Snowplow event
 * @param {Object} tagConfig - The tag configuration
 * @returns {boolean}
 */
const determineSpEncoding = (spEvent, tagConfig) => {
  if (spEvent.ue_px || spEvent.cx) {
    return true;
  }
  if (spEvent.ue_pr || spEvent.co) {
    return false;
  }
  return tagConfig.encodeBase64;
};

/**
 * Adds the configured context entities to the given snowplow event.
 *
 * @param {Object} spEvent - The Snowplow event
 * @param {Object} evObj - The common client event
 * @param {Object} tagConfig - The tag configuration
 * @returns {Object} The Snowplow event with contexts attached
 */
const addContextEntities = (spEvent, evObj, tagConfig) => {
  if (!spEvent) {
    return undefined;
  }
  const entities = mkEntities(evObj, tagConfig);
  if (entities) {
    const co = JSON.stringify({
      schema: spContextsSchema,
      data: entities,
    });

    const encode = determineSpEncoding(spEvent, tagConfig);
    if (encode) {
      spEvent.cx = base64urlencode(co);
    } else {
      spEvent.co = co;
    }
  }
  return spEvent;
};

/**
 * Given the client event object,
 *  - gets the Snowplow event from 'x-sp-tp2' (by Snowplow client)
 *  - or makes a Snowplow event
 *
 * @param {Object} evObj - The common event
 * @param {Object} tagConfig - The tag configuration
 * @param {function} definerFunction - The function to create the event definitions
 * @param {Object} The Snowplow event
 */
const buildSpEvent = (evObj, tagConfig, definerFunction) => {
  if (evObj['x-sp-tp2']) {
    const spEvent = evObj['x-sp-tp2'];
    spEvent.ip = evObj.ip_override;

    if (tagConfig.applyToSp) {
      return addContextEntities(spEvent, evObj, tagConfig);
    }

    return spEvent;
  }

  const spCustomDefs = definerFunction(tagConfig);
  const rawEvent = addContextEntities(
    mkSnowplowEvent(evObj, spCustomDefs, tagConfig),
    evObj,
    tagConfig
  );

  return rawEvent ? rawEvent : undefined;
};

/**
 * Given a Snowplow event, returns the Snowplow payload to be sent.
 *
 * @param {Object} snowplowEvent - The Snowplow event
 * @returns {Object} The Snowplow payload
 */
const mkSnowplowPayload = (snowplowEvent) => {
  if (snowplowEvent) {
    const snowplowPayload = {
      schema: spPayloadDataSchema,
      data: [snowplowEvent],
    };
    return snowplowPayload;
  }
  return undefined;
};

// Main
const eventData = getAllEventData();

const loggingEnabled = determineIsLoggingEnabled(data.logType);
const traceIdHeader = loggingEnabled ? getRequestHeader('trace-id') : undefined;
const stdLogInfo = {
  tagName: tagName,
  traceId: traceIdHeader,
  eventName: eventData.event_name,
};

if (!data.collectorUrl) {
  return fail(loggingEnabled, stdLogInfo, {
    msg: 'A collector URL must be specified',
  });
}

const collectorUrl = asCollectorUrl(data.collectorUrl);
const url = collectorUrl + spPostPath;

const definer = withDefinitions(spDefaultCustomDefs);
const snowplowEvent = buildSpEvent(eventData, data, definer);
const snowplowPayload = mkSnowplowPayload(snowplowEvent);

const requestOptions = {
  headers: getHeaders(eventData),
  method: 'POST',
  timeout: 5000,
};

if (snowplowPayload) {
  if (loggingEnabled) {
    doLogging('Request', stdLogInfo, {
      requestMethod: requestOptions.method,
      requestUrl: url,
      requestHeaders: requestOptions.headers,
      requestBody: snowplowPayload,
    });
  }

  sendHttpRequest(
    url,
    (statusCode, headers, body) => {
      if (loggingEnabled) {
        doLogging('Response', stdLogInfo, {
          responseStatusCode: statusCode,
          responseHeaders: headers,
          responseBody: body,
        });
      }

      if (statusCode >= 200 && statusCode < 300) {
        if (headers['set-cookie']) {
          setCookieFrom(headers, data);
        }
        data.gtmOnSuccess();
        return;
      }
      data.gtmOnFailure();
    },
    requestOptions,
    JSON.stringify(snowplowPayload)
  );
} else {
  fail(loggingEnabled, stdLogInfo, {
    msg: 'Unable to build Snowplow event from supplied Client event',
  });
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test Snowplow page_view event
  code: |
    // test constants
    const rawSnowplowEvent = snowplowTp2PageView;
    const mockSnowplowEvent = setMockEventObjectFromSpPv;
    const collectorUrl = 'collector.test.com';
    const expectedPostUrl = 'https://' + collectorUrl + spDefaultPostPath;

    const mockData = {
      collectorUrl: collectorUrl,

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockSnowplowEvent);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    assertThat(argUrl).isStrictlyEqualTo(expectedPostUrl);

    assertThat(argOptions.method).isStrictlyEqualTo('POST');
    assertThat(argOptions.timeout).isStrictlyEqualTo(5000);
    assertThat(argOptions.headers).isObject();
    assertThat(argOptions.headers['Content-Type']).isStrictlyEqualTo(
      'application/json'
    );
    assertThat(argOptions.headers['User-Agent']).isStrictlyEqualTo('curl/7.81.0');

    const body = jsonApi.parse(argBody);
    assertThat(body).isObject();
    assertThat(body.schema).isStrictlyEqualTo(spPayloadSchema);
    assertThat(body.data).isArray();

    const actEvent = body.data[0];
    assertThat(actEvent).isObject();
    assertThat(actEvent).isEqualTo(rawSnowplowEvent);

    assertApi('logToConsole').wasNotCalled();
- name: Test Snowplow page_view event with ip_override
  code: |
    const mockSnowplowEvent = snowplowTp2PageView;
    const mockEventObjectIpOverride = jsonApi.parse(
      jsonApi.stringify(setMockEventObjectFromSpPv)
    );
    mockEventObjectIpOverride.ip_override = '1.2.3.4';

    const collectorUrl = 'collector.test.com';

    const mockData = {
      collectorUrl: collectorUrl,

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      appId: 'should not apply to sp events',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEventObjectIpOverride);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();

    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];
    assertThat(actEvent.ip).isDefined();
    assertThat(actEvent.ip).isEqualTo(mockEventObjectIpOverride.ip_override);
    assertThat(actEvent.aid).isNotEqualTo('should not apply to sp events');
    assertThat(actEvent.aid).isEqualTo('website'); // original value

    assertApi('logToConsole').wasNotCalled();
- name: Test overriding login event
  code: |
    const mockEv = {
      event_name: 'login',
      engagement_time_msec: 2,
      method: 'Google',
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1075258766,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632072119',
      ga_session_number: 2,
      'x-ga-mp2-seg': '1',
      'x-ga-request_count': 2,
      ip_override: '1.2.3.4',
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    mock('getAllEventData', mockEv);

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: true,
      customEventSchemas: [
        {
          eventName: 'login',
          eventSchema: 'com.google.tag-manager.server-side/login/jsonschema/1-0-0',
        },
      ],
      customEventData: [
        {
          eventName: 'login',
          snowplowPropName: 'method',
          type: 'string',
          ref: 'eventProperty',
          value: 'method',
        },
      ],

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: false,
      platform: 'srv',
      appId: 'testApp',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('ue');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isStrictlyEqualTo('1.2.3.4');
    assertThat(actEvent.ue_pr).isDefined();
    assertThat(actEvent.ue_px).isUndefined();
    assertThat(actEvent.aid).isStrictlyEqualTo('testApp');

    const actSD = jsonApi.parse(actEvent.ue_pr);
    assertThat(actSD.schema).isStrictlyEqualTo(
      'iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0'
    );
    assertThat(actSD.data.schema).isStrictlyEqualTo(
      'iglu:com.google.tag-manager.server-side/login/jsonschema/1-0-0'
    );
    assertThat(actSD.data.data.method).isStrictlyEqualTo('Google');

    assertApi('logToConsole').wasNotCalled();
- name: Test custom structured event mp1
  code: |
    const mockEv = {
      'x-ga-protocol_version': '1',
      'x-ga-measurement_id': 'UA-XXXXX-Y',
      client_id: '3/t9e1OhwcZH4azSIsc8lyqxt8xgnyL1cCs8ciDouGI=',
      event_category: 'video',
      event_action: 'play',
      event_label: 'holiday',
      'x-ga-mp1-ev': '300',
      event_name: 'play',
      user_agent:
        'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:92.0) Gecko/20100101 Firefox/92.0',
      'x-ga-path': 'c',
      'x-ga-js_client_id': '555',
    };

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: true,
      customStructuredDefs: ['play'],
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      appId: '', // empty string ok
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('se');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      '3/t9e1OhwcZH4azSIsc8lyqxt8xgnyL1cCs8ciDouGI='
    );
    assertThat(actEvent.ue_pr).isUndefined();
    assertThat(actEvent.ue_px).isUndefined();

    assertThat(actEvent.se_ac).isStrictlyEqualTo('play');
    assertThat(actEvent.se_ca).isStrictlyEqualTo('video');
    assertThat(actEvent.se_la).isStrictlyEqualTo('holiday');
    assertThat(actEvent.se_pr).isUndefined();
    assertThat(actEvent.se_va).isUndefined();
    assertThat(actEvent.aid).isStrictlyEqualTo('');

    assertApi('logToConsole').wasNotCalled();
- name: Test custom structured event mp2
  code: |
    const mockEv = {
      event_name: 'video_auto_play_start',
      engagement_time_msec: 2,
      event_label: 'My promotional video',
      event_category: 'video_auto_play',
      non_interaction: 'true',
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1075258766,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632072119',
      ga_session_number: 2,
      'x-ga-mp2-seg': '1',
      'x-ga-request_count': 2,
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    mock('getAllEventData', mockEv);

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: true,
      customStructuredDefs: ['video_auto_play_start'],
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: false,
      platform: 'srv',
      // no appId set
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('se');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isUndefined();
    assertThat(actEvent.ue_pr).isUndefined();
    assertThat(actEvent.ue_px).isUndefined();

    assertThat(actEvent.se_ac).isStrictlyEqualTo('video_auto_play_start');
    assertThat(actEvent.se_ca).isStrictlyEqualTo('video_auto_play');
    assertThat(actEvent.se_la).isStrictlyEqualTo('My promotional video');
    assertThat(actEvent.se_pr).isUndefined();
    assertThat(actEvent.se_va).isUndefined();
    assertThat(actEvent.appId).isUndefined();

    assertApi('logToConsole').wasNotCalled();
- name: Test custom unstructured event
  code: |
    const mockEv = {
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1912195137,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      'x-ga-request_count': 2,
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632169709',
      ga_session_number: 8,
      'x-ga-mp2-seg': '1',
      event_name: 'foo',
      engagement_time_msec: 3118,
      age: 55,
      avg_page_load_time: 1,
      'x-ga-mp2-richsstsse': '',
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    const testVariable = [{ x: 1 }, { x: 2 }];
    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: true,
      customEventSchemas: [
        {
          eventName: 'foo',
          eventSchema: 'com.acme.test/foo/jsonschema/1-0-0',
        },
      ],
      customEventData: [
        {
          eventName: 'foo',
          snowplowPropName: 'foo_age',
          type: 'number',
          ref: 'eventProperty',
          value: 'age',
        },
        {
          eventName: 'foo',
          snowplowPropName: 'avg_load_time',
          type: 'number',
          ref: 'eventProperty',
          value: 'avg_page_load_time',
        },
        {
          eventName: 'foo',
          snowplowPropName: 'additionalData.isDebugMode',
          type: 'boolean',
          ref: 'userSet',
          value: true,
        },
        {
          eventName: 'foo',
          snowplowPropName: 'additionalObject.testArrayVar',
          type: 'default',
          ref: 'userSet',
          value: testVariable,
        },
      ],

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: false,
      platform: 'srv',
      appId: 3, // to test that non string value (e.g. through a variable) gets ignored
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('ue');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isUndefined();
    assertThat(actEvent.ue_pr).isDefined();
    assertThat(actEvent.ue_px).isUndefined();
    assertThat(actEvent.aid).isUndefined();

    const actSD = jsonApi.parse(actEvent.ue_pr);
    assertThat(actSD.schema).isStrictlyEqualTo(
      'iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0'
    );
    assertThat(actSD.data.schema).isStrictlyEqualTo(
      'iglu:com.acme.test/foo/jsonschema/1-0-0'
    );

    const expectedData = {
      foo_age: 55,
      avg_load_time: 1,
      additionalData: {
        isDebugMode: true,
      },
      additionalObject: {
        testArrayVar: testVariable,
      },
    };
    assertThat(actSD.data.data).isEqualTo(expectedData);

    assertApi('logToConsole').wasNotCalled();
- name: Test boolean type with exception event
  code: |
    const mockEv = {
      event_name: 'exception',
      engagement_time_msec: 1,
      description: 'no clue',
      fatal: 1,
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1013445257,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632157946',
      ga_session_number: 5,
      'x-ga-mp2-seg': '1',
      'x-ga-request_count': 5,
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: false,
      platform: 'srv',
      appId: 'my-app',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('ue');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isUndefined();
    assertThat(actEvent.ue_pr).isDefined();
    assertThat(actEvent.ue_px).isUndefined();
    assertThat(actEvent.aid).isStrictlyEqualTo('my-app');

    const actSD = jsonApi.parse(actEvent.ue_pr);
    assertThat(actSD.schema).isStrictlyEqualTo(
      'iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0'
    );
    assertThat(actSD.data.schema).isStrictlyEqualTo(
      'iglu:com.google.tag-manager.server-side/exception/jsonschema/1-0-0'
    );
    assertThat(actSD.data.data.description).isStrictlyEqualTo('no clue');
    assertThat(actSD.data.data.fatal).isTrue();

    assertApi('logToConsole').wasNotCalled();
- name: Test with purchase event
  code: |
    const mockEv = {
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAAA',
      'x-ga-gtm_version': '2oe9k0',
      'x-ga-page_id': 1319137026,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'r3R5aWLgblV9g+c7gLfLyCKbKGJNHNbkpziyFhjiFPc=.1632251814',
      'x-ga-request_count': 3,
      page_location: 'http://localhost/',
      page_title: '',
      currency: 'USD',
      ga_session_id: '1632251814',
      ga_session_number: 1,
      'x-ga-mp2-seg': '0',
      event_name: 'purchase',
      'x-ga-system_properties': { c: '1' },
      engagement_time_msec: 2907,
      items: [
        {
          item_id: 'sku123',
          item_name: 'myItemA',
          affiliation: 'Google store',
          coupon: 'myCouponA',
          discount: 5,
          index: 0,
          item_brand: 'myItemBrandA',
          item_category: 'myItemCategoryA1',
          item_category2: 'myItemCategoryA2',
          item_category3: 'myItemCategoryA3',
          item_category4: 'myItemCategoryA4',
          item_category5: 'myItemCategoryA5',
          item_list_id: 'abc123',
          item_list_name: 'listA',
          item_variant: 'blue',
          location_id: 'locA',
          price: 10.5,
          quantity: 3,
          currency: 'USD',
        },
        {
          item_id: 'sku456',
          item_name: 'myItemB',
          affiliation: 'Apple store',
          coupon: 'myCouponB',
          discount: 15,
          index: 9,
          item_brand: 'myItemBrandB',
          item_category: 'myItemCategoryB1',
          item_category2: 'myItemCategoryB2',
          item_category3: 'myItemCategoryB3',
          item_category4: 'myItemCategoryB4',
          item_category5: 'myItemCategoryB5',
          item_list_id: 'abc123',
          item_list_name: 'listB',
          item_variant: 'red',
          location_id: 'locB',
          price: 30.5,
          quantity: 12,
          currency: 'USD',
        },
      ],
      transaction_id: 'TR1234',
      value: 10,
      affiliation: 'myAffiliation',
      coupon: 'ABCD',
      shipping: 1,
      tax: 0.1,
      'x-ga-mp2-richsstsse': '',
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1542781271.1632251814',
    };

    const testVariable = [
      {
        schema: 'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
        data: { id: 'a948af5f-abbd-454e-b81e-04e69ff88106' },
      },
    ];

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      // testing also custom entities
      customEntities: [
        {
          eventName: 'purchase',
          ctxSchema:
            'com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          ctxProp: 'email_address',
          type: 'string',
          ref: 'userSet',
          value: 'foo@bar.baz',
        },
        {
          eventName: 'purchase',
          ctxSchema:
            'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          ctxProp: 'address.postal_code',
          type: 'default',
          ref: 'eventProperty',
          value: 'transaction_id',
        },
        {
          eventName: 'some_other_event',
          ctxSchema: 'iglu:com.acme/not/jsonschema/1-0-0',
          ctxProp: 'someProp',
          type: 'string',
          ref: 'userSet',
          value: 'shouldNotBe',
        },
      ],
      globalUseVariable: true,
      globalEntitiesFromVar: testVariable,

      encodeBase64: false,
      platform: 'srv',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('ue');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'r3R5aWLgblV9g+c7gLfLyCKbKGJNHNbkpziyFhjiFPc=.1632251814'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isUndefined();
    assertThat(actEvent.ue_pr).isDefined();
    assertThat(actEvent.ue_px).isUndefined();

    const actSD = jsonApi.parse(actEvent.ue_pr);
    assertThat(actSD.schema).isStrictlyEqualTo(
      'iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0'
    );
    assertThat(actSD.data.schema).isStrictlyEqualTo(
      'iglu:com.google.tag-manager.server-side/purchase/jsonschema/1-0-0'
    );

    assertThat(actSD.data.data.currency).isStrictlyEqualTo('USD');
    assertThat(actSD.data.data.transaction_id).isStrictlyEqualTo('TR1234');
    assertThat(actSD.data.data.value).isStrictlyEqualTo(10.0);
    assertThat(actSD.data.data.affiliation).isStrictlyEqualTo('myAffiliation');
    assertThat(actSD.data.data.coupon).isStrictlyEqualTo('ABCD');
    assertThat(actSD.data.data.shipping).isStrictlyEqualTo(1.0);
    assertThat(actSD.data.data.tax).isStrictlyEqualTo(0.1);

    const expectedItems = [
      {
        item_id: 'sku123',
        item_name: 'myItemA',
        affiliation: 'Google store',
        coupon: 'myCouponA',
        currency: 'USD',
        discount: 5.0,
        index: 0,
        item_brand: 'myItemBrandA',
        item_category: 'myItemCategoryA1',
        item_category2: 'myItemCategoryA2',
        item_category3: 'myItemCategoryA3',
        item_category4: 'myItemCategoryA4',
        item_category5: 'myItemCategoryA5',
        item_list_id: 'abc123',
        item_list_name: 'listA',
        item_variant: 'blue',
        location_id: 'locA',
        price: 10.5,
        quantity: 3,
      },
      {
        item_id: 'sku456',
        item_name: 'myItemB',
        affiliation: 'Apple store',
        coupon: 'myCouponB',
        currency: 'USD',
        discount: 15.0,
        index: 9,
        item_brand: 'myItemBrandB',
        item_category: 'myItemCategoryB1',
        item_category2: 'myItemCategoryB2',
        item_category3: 'myItemCategoryB3',
        item_category4: 'myItemCategoryB4',
        item_category5: 'myItemCategoryB5',
        item_list_id: 'abc123',
        item_list_name: 'listB',
        item_variant: 'red',
        location_id: 'locB',
        price: 30.5,
        quantity: 12,
      },
    ];

    const actualItems = actSD.data.data.items;

    assertThat(actualItems).isArray();
    assertThat(actualItems).isEqualTo(expectedItems);

    const expectedContexts = jsonApi.stringify({
      schema: 'iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0',
      data: [
        {
          schema:
            'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          data: {
            email_address: 'foo@bar.baz',
            address: { postal_code: 'TR1234' },
          },
        },
        testVariable[0],
      ],
    });
    assertThat(actEvent.co).isEqualTo(expectedContexts);
    assertThat(actEvent.cx).isUndefined();

    assertApi('logToConsole').wasNotCalled();
- name: Test contexts applying to tp2
  code: |
    // test constants
    const mockSnowplowEvent = mockEventObjectSelfDesc;
    const collectorUrl = 'test';
    const expectedPostUrl = 'https://' + collectorUrl + spDefaultPostPath;

    const mockData = {
      collectorUrl: collectorUrl,

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: true,
      customUseVariables: false,
      customEntities: [
        {
          eventName: 'media_player_event',
          ctxSchema:
            'com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          ctxProp: 'email_address',
          type: 'string',
          ref: 'eventProperty',
          value:
            'x-sp-contexts_com_google_tag-manager_server-side_user_data_1.0.email_address',
        },
        {
          eventName: 'media_player_event',
          ctxSchema:
            'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          ctxProp: 'address.postal_code',
          type: 'default',
          ref: 'userSet',
          value: 'foo',
        },
        {
          eventName: 'some_other_event',
          ctxSchema: 'iglu:com.acme/not/jsonschema/1-0-0',
          ctxProp: 'someProp',
          type: 'string',
          ref: 'userSet',
          value: 'shouldNotBe',
        },
      ],
      globalUseVariable: false,
      globalEntities: [
        {
          ctxSchema: 'com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          ctxProp: 'id',
          type: 'default',
          ref: 'userSet',
          value: 'a948af5f-abbd-454e-b81e-04e69ff88106',
        },
      ],

      encodeBase64: false,
      platform: 'srv',
      // logType undefined - testing also default logType is debug
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockSnowplowEvent);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();

    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    const expectedContexts = jsonApi.stringify({
      schema: 'iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0',
      data: [
        {
          schema:
            'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          data: {
            email_address: 'foo@test.io',
            address: { postal_code: 'foo' },
          },
        },
        {
          schema: 'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          data: { id: 'a948af5f-abbd-454e-b81e-04e69ff88106' },
        },
      ],
    });

    assertThat(actEvent.co).isEqualTo(expectedContexts);
    assertThat(actEvent.cx).isUndefined();

    assertApi('logToConsole').wasCalled();
- name: Test platform identifier
  code: |
    const mockEv = {
      event_name: 'exception',
      engagement_time_msec: 1,
      description: 'no clue',
      fatal: 1,
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1013445257,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632157946',
      ga_session_number: 5,
      'x-ga-mp2-seg': '1',
      'x-ga-request_count': 5,
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'iot',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.p).isStrictlyEqualTo('iot');

    assertApi('logToConsole').wasNotCalled();
- name: Test non-Snowplow page_view
  code: |
    const mockEv = {
      event_name: 'page_view',
      non_interaction: 'true',
      'x-ga-protocol_version': '2',
      'x-ga-measurement_id': 'G-AAAAAAAAA',
      'x-ga-gtm_version': '2oe9f0',
      'x-ga-page_id': 1075258766,
      screen_resolution: '1920x1080',
      language: 'en-us',
      client_id: 'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552',
      page_location: 'http://localhost/',
      page_title: '',
      ga_session_id: '1632072119',
      ga_session_number: 2,
      'x-ga-mp2-seg': '1',
      'x-ga-request_count': 2,
      user_agent:
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
      'x-ga-js_client_id': '1182338296.1632069552',
    };

    const testVariable = [
      {
        schema:
          'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
        data: {
          email_address: 'foo@bar.baz',
          address: { postal_code: 'TR1234' },
        },
      },
    ];

    mock('getAllEventData', mockEv);

    const mockData = {
      collectorUrl: 'test',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: true,
      customEntitiesFromVar: [
        {
          eventName: 'page_view',
          customContexts: testVariable,
        },
      ],

      globalUseVariable: false,
      globalEntities: [
        {
          ctxSchema: 'com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          ctxProp: 'id',
          type: 'default',
          ref: 'userSet',
          value: 'a948af5f-abbd-454e-b81e-04e69ff88106',
        },
      ],

      encodeBase64: false,
      platform: 'srv',
      appId: 'testApp',
      logType: 'no',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEv);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    assertThat(actEvent.e).isStrictlyEqualTo('pv');
    assertThat(actEvent.url).isStrictlyEqualTo('http://localhost/');
    assertThat(actEvent.duid).isStrictlyEqualTo(
      'lyqi3wb1lPr5UDBKiFVZgj7ZFM8yptEK98924tMNsv0=.1632069552'
    );
    assertThat(actEvent.lang).isStrictlyEqualTo('en-us');
    assertThat(actEvent.res).isStrictlyEqualTo('1920x1080');
    assertThat(actEvent.ip).isUndefined();
    assertThat(actEvent.ue_pr).isUndefined();
    assertThat(actEvent.ue_px).isUndefined();
    assertThat(actEvent.aid).isStrictlyEqualTo('testApp');

    const expectedContexts = jsonApi.stringify({
      schema: 'iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0',
      data: [
        {
          schema: 'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          data: { id: 'a948af5f-abbd-454e-b81e-04e69ff88106' },
        },
        testVariable[0],
      ],
    });
    assertThat(actEvent.co).isEqualTo(expectedContexts);
    assertThat(actEvent.cx).isUndefined();

    assertApi('logToConsole').wasNotCalled();
- name: Test logs settings - debug does not log on prod
  code: |
    // test constants
    const mockEventObject = setMockEventObjectFromSpPv;

    const mockData = {
      collectorUrl: 'collector.test.com',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      logType: 'debug',
    };

    // mock API
    mock('getAllEventData', mockEventObject);
    mock('sendHttpRequest', function () {
      return true;
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: false,
        previewMode: false,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    assertApi('logToConsole').wasNotCalled();
- name: Test logs settings - no does not log on prod
  code: |
    // test constants
    const mockSnowplowEvent = setMockEventObjectFromSpPv;

    const mockData = {
      collectorUrl: 'collector.test.com',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: true,
      customUseVariables: false,
      customEntities: [
        {
          eventName: 'page_view',
          ctxSchema:
            'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          ctxProp: 'id',
          type: 'default',
          ref: 'eventProperty',
          value:
            'x-sp-contexts_com_snowplowanalytics_snowplow_web_page_1.0.id',
        },
      ],
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      logType: 'no',
    };

    // mock API
    mock('getAllEventData', mockSnowplowEvent);
    let argUrl, argCallback, argOptions, argBody;
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: false,
        previewMode: false,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    //assertApi('logToConsole').wasNotCalled();

    // Assert on contexts/encoding
    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    const expectedContexts = jsonApi.stringify({
      schema: 'iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0',
      data: [
        {
          schema: 'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          data: { id: mockSnowplowEvent['x-sp-contexts_com_snowplowanalytics_snowplow_web_page_1'][0].id },
        },
      ],
    });

    assertThat(actEvent.cx).isDefined();
    assertThat(actEvent.co).isUndefined();

    const fromBase64 = require('fromBase64');
    const base64urldecode = (data) => {
      const padding = 4 - (data.length % 4);
      switch (padding) {
        case 1:
          data += '=';
          break;
        case 2:
          data += '==';
          break;
        case 3:
          data += '=';
          break;
      }
      const b64Data = data.replace('-', '+').replace('_', '/');
      return fromBase64(b64Data);
    };

    const actualContexts = base64urldecode(actEvent.cx);
    assertThat(actualContexts).isEqualTo(expectedContexts);
- name: Test logs settings (always in prod) and base64urlencode
  code: |
    // test constants
    const mockEventObject = setMockEventObjectFromSpPv;

    const mockData = {
      collectorUrl: 'collector.test.com',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: true,
      customUseVariables: false,
      customEntities: [
        {
          eventName: 'page_view',
          ctxSchema:
            'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
          ctxProp: 'address.postal_code',
          type: 'default',
          ref: 'userSet',
          value: 'foo',
        },
      ],
      globalUseVariable: false,
      globalEntities: [
        {
          ctxSchema: 'com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
          ctxProp: 'id',
          type: 'default',
          ref: 'userSet',
          value: 'a948af5f-abbd-454e-b81e-04e69ff88106',
        },
      ],

      encodeBase64: false,
      platform: 'srv',
      logType: 'always',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;
    // mock API
    mock('getAllEventData', mockEventObject);
    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: false,
        previewMode: false,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    assertApi('logToConsole').wasCalled();

    const body = jsonApi.parse(argBody);
    const actEvent = body.data[0];

    const expectedContexts = 'eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvdy9jb250ZXh0cy9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6W3sic2NoZW1hIjoiaWdsdTpjb20uZ29vZ2xlLnRhZy1tYW5hZ2VyLnNlcnZlci1zaWRlL3VzZXJfZGF0YS9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJhZGRyZXNzIjp7InBvc3RhbF9jb2RlIjoiZm9vIn19fSx7InNjaGVtYSI6ImlnbHU6Y29tLnNub3dwbG93YW5hbHl0aWNzLnNub3dwbG93L3dlYl9wYWdlL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7ImlkIjoiYTk0OGFmNWYtYWJiZC00NTRlLWI4MWUtMDRlNjlmZjg4MTA2In19XX0';
    assertThat(actEvent.cx).isEqualTo(expectedContexts);
    assertThat(actEvent.co).isUndefined();
- name: Test logs settings - always (2)
  code: |
    // test constants
    const mockEventObject = setMockEventObjectFromSpPv;

    const mockData = {
      collectorUrl: 'collector.test.com',

      userIdCookie: 'sp',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      logType: 'always',
    };

    // mock API
    mock('getAllEventData', mockEventObject);
    mock('sendHttpRequest', function () {
      return true;
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    assertApi('logToConsole').wasCalled();
- name: Test logs and cookie headers - Request and Response
  code: |
    const decodeUri = require('decodeUriComponent');

    // test constants
    const mockSnowplowEvent = snowplowTp2PageView;
    const mockEventObject = setMockEventObjectFromSpPv;
    const testCollector = 'collector.test.com';

    const mockData = {
      collectorUrl: 'collector.test.com',

      userIdCookie: 'micro',
      cookieOverrideEnabled: false,
      forwardCookieHeaders: true,
      cookiesToForward: [
        { cookieName: 'foo', decode: 'no' },
        { cookieName: 'bar', decode: 'no' },
        { cookieName: 'baz', decode: 'yes' },
        { cookieName: 'notexists', decode: 'no' },
      ],

      defineAsStructured: false,
      defineAsSelfDescribing: false,

      applyToSp: false,
      customUseVariables: false,
      globalUseVariable: false,

      encodeBase64: true,
      platform: 'srv',
      logType: 'debug',
    };

    // to assert on
    let argUrl, argCallback, argOptions, argBody;

    // mock API
    mock('getAllEventData', mockEventObject);

    mock('sendHttpRequest', function () {
      argUrl = arguments[0];
      argCallback = arguments[1];
      argOptions = arguments[2];
      argBody = arguments[3];

      // mock response
      let respStatusCode = 200;
      let respHeaders = {
        foo: 'bar',
        'set-cookie':
          'micro=60f9c826-79b4-46b1-b27c-4f816899c09f; Expires=Sat, 15 Jun 2024 20:06:33 GMT; Path=/',
      };
      let respBody = 'ok';

      // and call the callback with mock response
      argCallback(respStatusCode, respHeaders, respBody);
    });
    mock('getContainerVersion', function () {
      let containerVersion = {
        debugMode: true,
        previewMode: true,
      };
      return containerVersion;
    });
    mock('getRequestHeader', function (key) {
      // only interested for trace-id
      const headers = {
        'trace-id': 'someTestTraceId',
      };
      // naive
      return headers[key];
    });

    // mocking based on
    // https://developers.google.com/tag-platform/tag-manager/templates/api#getcookievalues
    mock('getCookieValues', function (cookieName, noDecode) {
      const testMap = {
        foo: ['a', 'b'],
        bar: ['test%26%3F'],
        baz: ['test%26%3F'],
      };

      const cookieVals = testMap[cookieName] || [];
      if (noDecode) {
        return cookieVals;
      }

      return cookieVals.map((v) => decodeUri(v));
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();

    const expectedUrl = 'https://' + testCollector + spDefaultPostPath;
    const expectedHeaders = {
      'Content-Type': 'application/json',
      'User-Agent': 'curl/7.81.0',
      'SP-Anonymous': '*',
      Cookie: 'foo=a; foo=b; bar=test%26%3F; baz=test&?',
    };
    const expectedRequestLog = jsonApi.stringify({
      Name: 'Snowplow',
      Type: 'Request',
      TraceId: 'someTestTraceId',
      EventName: 'page_view',
      RequestMethod: 'POST',
      RequestUrl: expectedUrl,
      RequestHeaders: expectedHeaders,
      RequestBody: {
        schema: spPayloadSchema,
        data: [mockSnowplowEvent],
      },
    });

    const expectedResponseLog = jsonApi.stringify({
      Name: 'Snowplow',
      Type: 'Response',
      TraceId: 'someTestTraceId',
      EventName: 'page_view',
      ResponseStatusCode: 200,
      ResponseHeaders: {
        foo: 'bar',
        'set-cookie':
          'micro=60f9c826-79b4-46b1-b27c-4f816899c09f; Expires=Sat, 15 Jun 2024 20:06:33 GMT; Path=/',
      },
      ResponseBody: 'ok',
    });

    assertThat(argOptions.headers).isEqualTo(expectedHeaders);
    assertApi('setCookie').wasCalled();
    assertApi('setCookie').wasCalledWith(
      'micro',
      '60f9c826-79b4-46b1-b27c-4f816899c09f',
      {
        domain: 'auto',
        path: '/',
        httpOnly: true,
        secure: true,
        sameSite: 'Lax',
        expires: 'Sat, 15 Jun 2024 20:06:33 GMT',
      }
    );
    assertApi('logToConsole').wasCalled();
    assertApi('logToConsole').wasCalledWith(expectedRequestLog);
    assertApi('logToConsole').wasCalledWith(expectedResponseLog);
- name: Test logs - containerVersion undefined
  code: |
    // test constants
    const mockEventObject = setMockEventObjectFromSpPv;

    const mockData = {
      encodeBase64: true,
      userIdCookie: 'sp',
      defineAsStructured: false,
      cookieOverrideEnabled: false,
      forwardCookieHeaders: false,
      collectorUrl: 'collector.test.com',
      defineAsSelfDescribing: false,
      logType: 'debug', // so that we assert on fallback for undefined containerVersion()
    };

    // mock API
    mock('getAllEventData', mockEventObject);
    mock('sendHttpRequest', function () {
      return true;
    });
    mock('getContainerVersion', function () {
      return undefined;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Assert
    assertApi('sendHttpRequest').wasCalled();
    assertApi('logToConsole').wasNotCalled();
setup: |-
  const jsonApi = require('JSON');
  const logToConsole = require('logToConsole');

  const spPayloadSchema =
    'iglu:com.snowplowanalytics.snowplow/payload_data/jsonschema/1-0-4';
  const spDefaultPostPath = '/com.snowplowanalytics.snowplow/tp2';
  const snowplowTp2PageView = {
    e: 'pv',
    url: 'https://snowplowanalytics.com/',
    page: 'Collect, manage and operationalize behavioral data at scale | Snowplow',
    tv: 'js-3.1.4',
    tna: 'sp',
    aid: 'website',
    p: 'web',
    tz: 'Europe/London',
    lang: 'en-GB',
    cs: 'UTF-8',
    res: '1920x1080',
    cd: '24',
    cookie: '1',
    eid: '8676de79-0eba-4435-ad95-8a41a8a0129c',
    dtm: '1628586512246',
    cx: 'eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvdy9jb250ZXh0cy9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6W3sic2NoZW1hIjoiaWdsdTpjb20uc25vd3Bsb3dhbmFseXRpY3Muc25vd3Bsb3cvd2ViX3BhZ2UvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsiaWQiOiJhODZjNDJlNS1iODMxLTQ1YzgtYjcwNi1lMjE0YzI2YjRiM2QifX0seyJzY2hlbWEiOiJpZ2x1Om9yZy53My9QZXJmb3JtYW5jZVRpbWluZy9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJuYXZpZ2F0aW9uU3RhcnQiOjE2Mjg1ODY1MDg2MTAsInVubG9hZEV2ZW50U3RhcnQiOjAsInVubG9hZEV2ZW50RW5kIjowLCJyZWRpcmVjdFN0YXJ0IjowLCJyZWRpcmVjdEVuZCI6MCwiZmV0Y2hTdGFydCI6MTYyODU4NjUwODYxMCwiZG9tYWluTG9va3VwU3RhcnQiOjE2Mjg1ODY1MDg2MzcsImRvbWFpbkxvb2t1cEVuZCI6MTYyODU4NjUwODY5MSwiY29ubmVjdFN0YXJ0IjoxNjI4NTg2NTA4NjkxLCJjb25uZWN0RW5kIjoxNjI4NTg2NTA4NzYzLCJzZWN1cmVDb25uZWN0aW9uU3RhcnQiOjE2Mjg1ODY1MDg3MjEsInJlcXVlc3RTdGFydCI6MTYyODU4NjUwODc2MywicmVzcG9uc2VTdGFydCI6MTYyODU4NjUwODc5NywicmVzcG9uc2VFbmQiOjE2Mjg1ODY1MDg4MjEsImRvbUxvYWRpbmciOjE2Mjg1ODY1MDkwNzYsImRvbUludGVyYWN0aXZlIjoxNjI4NTg2NTA5MzgxLCJkb21Db250ZW50TG9hZGVkRXZlbnRTdGFydCI6MTYyODU4NjUwOTQwOCwiZG9tQ29udGVudExvYWRlZEV2ZW50RW5kIjoxNjI4NTg2NTA5NDE3LCJkb21Db21wbGV0ZSI6MTYyODU4NjUxMDMzMiwibG9hZEV2ZW50U3RhcnQiOjE2Mjg1ODY1MTAzMzIsImxvYWRFdmVudEVuZCI6MTYyODU4NjUxMDMzNH19XX0',
    vp: '745x1302',
    ds: '730x12393',
    vid: '1',
    sid: 'e7580b71-227b-4868-9ea9-322a263ce885',
    duid: 'd54a1904-7798-401a-be0b-1a83bea73634',
    stm: '1628586512248',
    uid: 'snow123',
  };

  const setMockEventObjectFromSpPv = {
    event_name: 'page_view',
    language: 'en-GB',
    page_encoding: 'UTF-8',
    page_hostname: 'snowplowanalytics.com',
    page_location: 'https://snowplowanalytics.com/',
    page_path: '/',
    page_title:
      'Collect, manage and operationalize behavioral data at scale | Snowplow',
    screen_resolution: '1920x1080',
    viewport_size: '745x1302',
    user_agent: 'curl/7.81.0',
    host: 'engineering-sandbox.appspot.com',
    'x-sp-app_id': 'website',
    'x-sp-platform': 'web',
    'x-sp-dvce_created_tstamp': '1628586512246',
    'x-sp-event_id': '8676de79-0eba-4435-ad95-8a41a8a0129c',
    'x-sp-name_tracker': 'sp',
    'x-sp-v_tracker': 'js-3.1.4',
    'x-sp-domain_sessionid': 'e7580b71-227b-4868-9ea9-322a263ce885',
    'x-sp-domain_sessionidx': 1,
    'x-sp-domain_userid': 'd54a1904-7798-401a-be0b-1a83bea73634',
    'x-sp-user_id': 'snow123',
    'x-sp-br_cookies': '1',
    'x-sp-br_colordepth': '24',
    'x-sp-br_viewwidth': 745,
    'x-sp-br_viewheight': 1302,
    'x-sp-dvce_screenwidth': 1920,
    'x-sp-dvce_screenheight': 1080,
    'x-sp-doc_charset': 'UTF-8',
    'x-sp-doc_width': 730,
    'x-sp-doc_height': 12393,
    'x-sp-dvce_sent_tstamp': '1628586512248',
    'x-sp-tp2': jsonApi.parse(jsonApi.stringify(snowplowTp2PageView)),
    'x-sp-anonymous': '*',
    'x-sp-contexts_com_snowplowanalytics_snowplow_web_page_1': [
      { id: 'a86c42e5-b831-45c8-b706-e214c26b4b3d' },
    ],
    'x-sp-contexts_org_w3_performance_timing_1': [
      {
        navigationStart: 1628586508610,
        unloadEventStart: 0,
        unloadEventEnd: 0,
        redirectStart: 0,
        redirectEnd: 0,
        fetchStart: 1628586508610,
        domainLookupStart: 1628586508637,
        domainLookupEnd: 1628586508691,
        connectStart: 1628586508691,
        connectEnd: 1628586508763,
        secureConnectionStart: 1628586508721,
        requestStart: 1628586508763,
        responseStart: 1628586508797,
        responseEnd: 1628586508821,
        domLoading: 1628586509076,
        domInteractive: 1628586509381,
        domContentLoadedEventStart: 1628586509408,
        domContentLoadedEventEnd: 1628586509417,
        domComplete: 1628586510332,
        loadEventStart: 1628586510332,
        loadEventEnd: 1628586510334,
      },
    ],
    ga_session_id: 'e7580b71-227b-4868-9ea9-322a263ce885',
    ga_session_number: '1',
    'x-ga-mp2-seg': '1',
    'x-ga-protocol_version': '2',
    'x-ga-page_id': 'a86c42e5-b831-45c8-b706-e214c26b4b3d',
    client_id: 'd54a1904-7798-401a-be0b-1a83bea73634',
    user_id: 'snow123',
  };

  const mockEventObjectSelfDesc = {
    event_name: 'media_player_event',
    client_id: 'fd0e5288-e89b-45df-aad5-6d0c6eda6198',
    language: 'en-US',
    page_encoding: 'windows-1252',
    page_hostname: 'localhost',
    page_location: 'http://localhost:8000/',
    page_path: '/',
    screen_resolution: '1920x1080',
    user_id: 'tester',
    viewport_size: '1044x975',
    user_agent: 'curl/7.81.0',
    host: 'host',
    'x-sp-app_id': 'media-test',
    'x-sp-platform': 'web',
    'x-sp-dvce_created_tstamp': '1658567928426',
    'x-sp-event_id': 'c2084e30-5e4f-4d9c-86b2-e0bc3781509a',
    'x-sp-name_tracker': 'spTest',
    'x-sp-v_tracker': 'js-3.5.0',
    'x-sp-domain_sessionid': '1ab28b79-bfdd-4855-9bf1-5199ce15beac',
    'x-sp-domain_sessionidx': 1,
    'x-sp-br_cookies': '1',
    'x-sp-br_colordepth': '24',
    'x-sp-br_viewwidth': 1044,
    'x-sp-br_viewheight': 975,
    'x-sp-dvce_screenwidth': 1920,
    'x-sp-dvce_screenheight': 1080,
    'x-sp-doc_charset': 'windows-1252',
    'x-sp-doc_width': 1044,
    'x-sp-doc_height': 975,
    'x-sp-dvce_sent_tstamp': '1658567928427',
    'x-sp-tp2': {
      e: 'ue',
      eid: 'c2084e30-5e4f-4d9c-86b2-e0bc3781509a',
      tv: 'js-3.5.0',
      tna: 'spTest',
      aid: 'media-test',
      p: 'web',
      cookie: '1',
      cs: 'windows-1252',
      lang: 'en-US',
      res: '1920x1080',
      cd: '24',
      tz: 'Europe/Athens',
      dtm: '1658567928426',
      vp: '1044x975',
      ds: '1044x975',
      vid: '1',
      sid: '1ab28b79-bfdd-4855-9bf1-5199ce15beac',
      duid: 'fd0e5288-e89b-45df-aad5-6d0c6eda6198',
      uid: 'tester',
      url: 'http://localhost:8000/',
      ue_pr:
        '{"schema":"iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0","data":{"schema":"iglu:com.snowplowanalytics.snowplow/media_player_event/jsonschema/1-0-0","data":{"type":"play"}}}',
      co: '{"schema":"iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0","data":[{"schema":"iglu:com.youtube/youtube/jsonschema/1-0-0","data":{"autoPlay":false,"avaliablePlaybackRates":[0.25,0.5,0.75,1,1.25,1.5,1.75,2],"buffering":false,"controls":true,"cued":false,"loaded":3,"playbackQuality":"medium","playerId":"youtube-song","unstarted":false,"url":"https://www.youtube.com/watch?v=XCQK6LmhYqc","avaliableQualityLevels":["hd1080","hd720","large","medium","small","tiny","auto"]}},{"schema":"iglu:com.snowplowanalytics.snowplow/media_player/jsonschema/1-0-0","data":{"currentTime":0.015303093460083008,"duration":190.301,"ended":false,"loop":false,"muted":false,"paused":false,"playbackRate":1,"volume":100}},{"schema":"iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0","data":{"id":"68027aa2-34b1-4018-95e3-7176c62dbc84"}},{"schema":"iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0","data":{"email_address":"foo@test.io"}},{"schema":"iglu:com.snowplowanalytics.snowplow/client_session/jsonschema/1-0-2","data":{"userId":"fd0e5288-e89b-45df-aad5-6d0c6eda6198","sessionId":"1ab28b79-bfdd-4855-9bf1-5199ce15beac","eventIndex":24,"sessionIndex":1,"previousSessionId":null,"storageMechanism":"COOKIE_1","firstEventId":"40fbdb30-1b99-42a3-99f7-850dacf5be43","firstEventTimestamp":"2022-07-23T09:08:04.451Z"}}]}',
      stm: '1658567928427',
    },
    'x-sp-self_describing_event_com_snowplowanalytics_snowplow_media_player_event_1':
      { type: 'play' },
    'x-sp-contexts_com_youtube_youtube_1': [
      {
        autoPlay: false,
        avaliablePlaybackRates: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
        buffering: false,
        controls: true,
        cued: false,
        loaded: 3,
        playbackQuality: 'medium',
        playerId: 'youtube-song',
        unstarted: false,
        url: 'https://www.youtube.com/watch?v=XCQK6LmhYqc',
        avaliableQualityLevels: [
          'hd1080',
          'hd720',
          'large',
          'medium',
          'small',
          'tiny',
          'auto',
        ],
      },
    ],
    'x-sp-contexts_com_snowplowanalytics_snowplow_media_player_1': [
      {
        currentTime: 0.015303093460083008,
        duration: 190.301,
        ended: false,
        loop: false,
        muted: false,
        paused: false,
        playbackRate: 1,
        volume: 100,
      },
    ],
    'x-sp-contexts_com_snowplowanalytics_snowplow_web_page_1': [
      { id: '68027aa2-34b1-4018-95e3-7176c62dbc84' },
    ],
    'x-sp-contexts_com_google_tag-manager_server-side_user_data_1': [
      { email_address: 'foo@test.io' },
    ],
    'x-sp-contexts_com_snowplowanalytics_snowplow_client_session_1': [
      {
        userId: 'fd0e5288-e89b-45df-aad5-6d0c6eda6198',
        sessionId: '1ab28b79-bfdd-4855-9bf1-5199ce15beac',
        eventIndex: 24,
        sessionIndex: 1,
        previousSessionId: null,
        storageMechanism: 'COOKIE_1',
        firstEventId: '40fbdb30-1b99-42a3-99f7-850dacf5be43',
        firstEventTimestamp: '2022-07-23T09:08:04.451Z',
      },
    ],
    'x-sp-contexts': [
      {
        schema: 'iglu:com.youtube/youtube/jsonschema/1-0-0',
        data: {
          autoPlay: false,
          avaliablePlaybackRates: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
          buffering: false,
          controls: true,
          cued: false,
          loaded: 3,
          playbackQuality: 'medium',
          playerId: 'youtube-song',
          unstarted: false,
          url: 'https://www.youtube.com/watch?v=XCQK6LmhYqc',
          avaliableQualityLevels: [
            'hd1080',
            'hd720',
            'large',
            'medium',
            'small',
            'tiny',
            'auto',
          ],
        },
      },
      {
        schema:
          'iglu:com.snowplowanalytics.snowplow/media_player/jsonschema/1-0-0',
        data: {
          currentTime: 0.015303093460083008,
          duration: 190.301,
          ended: false,
          loop: false,
          muted: false,
          paused: false,
          playbackRate: 1,
          volume: 100,
        },
      },
      {
        schema: 'iglu:com.snowplowanalytics.snowplow/web_page/jsonschema/1-0-0',
        data: { id: '68027aa2-34b1-4018-95e3-7176c62dbc84' },
      },
      {
        schema:
          'iglu:com.google.tag-manager.server-side/user_data/jsonschema/1-0-0',
        data: { email_address: 'foo@test.io' },
      },
      {
        schema:
          'iglu:com.snowplowanalytics.snowplow/client_session/jsonschema/1-0-2',
        data: {
          userId: 'fd0e5288-e89b-45df-aad5-6d0c6eda6198',
          sessionId: '1ab28b79-bfdd-4855-9bf1-5199ce15beac',
          eventIndex: 24,
          sessionIndex: 1,
          previousSessionId: null,
          storageMechanism: 'COOKIE_1',
          firstEventId: '40fbdb30-1b99-42a3-99f7-850dacf5be43',
          firstEventTimestamp: '2022-07-23T09:08:04.451Z',
        },
      },
    ],
    user_data: { email_address: 'foo@test.io' },
    ga_session_id: '1ab28b79-bfdd-4855-9bf1-5199ce15beac',
    ga_session_number: '1',
    'x-ga-mp2-seg': '1',
    'x-ga-protocol_version': '2',
    'x-ga-page_id': '68027aa2-34b1-4018-95e3-7176c62dbc84',
  };


___NOTES___

Created on 9/21/2021, 3:59:19 AM
